<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Building a web application with Mojolicious and Ember - Part Two by keithbro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Building a web application with Mojolicious and Ember - Part Two</h1>
      <h2 class="project-tagline">7th February 2016</h2>
      <a href="https://github.com/keithbro/build-an-app-with-mojolicious-and-ember-part-2" class="btn">View on GitHub</a>
      <a href="https://github.com/keithbro/build-an-app-with-mojolicious-and-ember-part-2/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/keithbro/build-an-app-with-mojolicious-and-ember-part-2/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p>This is the second part of a multi-part tutorial which will help you get started developing web applications using <a href="http://mojolicious.org">Mojolicious</a> and <a href="http://emberjs.com">Ember</a>. In the <a href="http://keithbro.github.io/build-an-app-with-mojolicious-and-ember-part-1">first part</a>, we got everything installed and finished at the point where we had front-end and back-end development servers running. The following instructions assume that both servers are still running.</p>

<h2>
<a id="our-application" class="anchor" href="#our-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Our Application</h2>

<p>The application we will create will be very simple, but will show how everything ties together and will lay the groundwork for building something more complex. On the landing page, the user will see a list of music artists. When the user clicks on each artist, they should see more information about that artist, including their albums. For the first iteration, the application will be read-only, but later on we'll add functionality such that the user can add artists and albums.</p>

<h2>
<a id="ember-cli-resources" class="anchor" href="#ember-cli-resources" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Ember-CLI Resources</h2>

<p>Ember-CLI provides the concept of a "resource" which consists of a model, a route and a template. If we generate a resource called artists, it will take us a long way towards our goal of displaying a list of artists to the user. We can also define what attributes artists should have, for example, every artist has a name which is a string.</p>

<pre><code>~/music-app/ember$ ember generate resource artists name:string
version: 1.13.15
installing model
  create app/models/artist.js
installing model-test
  create tests/unit/models/artist-test.js
installing route
  create app/routes/artists.js
  create app/templates/artists.hbs
updating router
  add route artists
installing route-test
  create tests/unit/routes/artists-test.js
</code></pre>

<p>That generated a lot of code! It even set up unit tests for our model and route. Thanks Ember-CLI!</p>

<p>So what does this mean for us? Well, we now have a new endpoint on our front-end - <a href="http://localhost:4200/artists">http://localhost:4200/artists</a>. Unfortunately, there's nothing interesting there yet - just the normal "Welcome to Ember" message. We still need to tell Ember what this route should actually do. When the user lands on this page, the front-end should request the list of artists from the back-end. Let's implement that.</p>

<h2>
<a id="ember-routes" class="anchor" href="#ember-routes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Ember Routes</h2>

<p>In Ember, routes are responsible for loading data. Open <code>ember/app/routes/artists.js</code> and change it to the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">import</span> <span class="pl-smi">Ember</span> <span class="pl-k">from</span> <span class="pl-s"><span class="pl-pds">'</span>ember<span class="pl-pds">'</span></span>;

<span class="pl-k">export</span> <span class="pl-v">default</span> <span class="pl-smi">Ember</span>.<span class="pl-smi">Route</span>.<span class="pl-en">extend</span>({
  <span class="pl-en">model</span>() {
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-smi">store</span>.<span class="pl-en">findAll</span>(<span class="pl-s"><span class="pl-pds">'</span>artist<span class="pl-pds">'</span></span>);
  },
});</pre></div>

<p>Translated to English, we've used the "store", which is part of ember-data, to <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_findAll">"findAll"</a> artists on the back-end server. When the store returns data, the data will be set as the "model" for this route.</p>

<p>Save the file and if you still have /artists open in your browser, you'll notice that it auto-reloaded (thanks again Ember-CLI). However, this time, the "Welcome to Ember" message has disappeared. Look in the console, and you'll see an error has occurred.</p>

<pre><code>GET http://localhost:4200/artists 404 (Not Found)
</code></pre>

<p>This is good. It means that Ember is now requesting data from the server, but the server replied saying that it has no knowledge about artists.</p>

<h2>
<a id="mojolicious-routes" class="anchor" href="#mojolicious-routes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Mojolicious Routes</h2>

<p>In Mojolicious, routes are responsible for responding to incoming requests. Reacting to the above error, the next logical step is to respond to the Ember application's request for artists. Open <code>mojo/lib/MusicApp.pm</code>, and change it to the following:</p>

<div class="highlight highlight-source-perl"><pre><span class="pl-k">package</span> <span class="pl-en">MusicApp</span>;
<span class="pl-k">use</span> Mojo::Base <span class="pl-s"><span class="pl-pds">'</span>Mojolicious<span class="pl-pds">'</span></span>;

<span class="pl-k">sub</span> <span class="pl-en">startup</span> {
    <span class="pl-k">my</span> <span class="pl-smi">$self</span> = <span class="pl-c1">shift</span>;

    <span class="pl-k">my</span> <span class="pl-smi">$r</span> = <span class="pl-smi">$self</span><span class="pl-k">-&gt;</span>routes;

    <span class="pl-smi">$r</span><span class="pl-k">-&gt;</span>get(<span class="pl-s"><span class="pl-pds">'</span>/artists<span class="pl-pds">'</span></span>)<span class="pl-k">-&gt;</span>to(<span class="pl-c1">cb</span> <span class="pl-k">=&gt;</span> <span class="pl-k">sub</span> {
        <span class="pl-k">my</span> <span class="pl-smi">$c</span> = <span class="pl-c1">shift</span>;

        <span class="pl-k">my</span> <span class="pl-smi">$artists</span> = [
            {
                <span class="pl-c1">id</span> <span class="pl-k">=&gt;</span> 1,
                <span class="pl-c1">name</span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">"</span>Michael Jackson<span class="pl-pds">"</span></span>,
            },
            {
                <span class="pl-c1">id</span> <span class="pl-k">=&gt;</span> 2,
                <span class="pl-c1">name</span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">"</span>Eminem<span class="pl-pds">"</span></span>,
            },
        ];

        <span class="pl-smi">$c</span><span class="pl-k">-&gt;</span>render(<span class="pl-c1">json</span> <span class="pl-k">=&gt;</span> { <span class="pl-c1">artists</span> <span class="pl-k">=&gt;</span> <span class="pl-smi">$artists</span> });
    });
}

1;</pre></div>

<p>OK, so we've cheated a bit by hard-coding the artist data. In a while we'll replace the hard-coded data by a call to the database, but let's just get it working for now. We'll return it as JSON when the something hits the /artists endpoint.</p>

<p>Reload the front-end, and the "Welcome to Ember" should have reappeared. If you look at the console, the error should have disappeared and if you inspect the network traffic, you should see a successful response from the back-end with the artist data. However, we still don't see the artist data on the page. This is because we haven't defined how the data should appear on the page.</p>

<h2>
<a id="ember-templates" class="anchor" href="#ember-templates" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Ember Templates</h2>

<p>In Ember, templates are responsible for what should be displayed. Open <code>ember/app/templates/artists.hbs</code>, and change it to the following:</p>

<div class="highlight highlight-text-html-handlebars"><pre><span class="pl-c1">{{#each</span> <span class="pl-v">model</span> <span class="pl-c1">as</span> |artist|<span class="pl-c1">}}</span>
  &lt;<span class="pl-ent">div</span> <span class="pl-e"><span class="pl-e">class</span>=</span><span class="pl-s"><span class="pl-pds">"</span>artist<span class="pl-pds">"</span></span>&gt;
    <span class="pl-c1">{{</span><span class="pl-v">artist.name</span><span class="pl-c1">}}</span>
  &lt;/<span class="pl-ent">div</span>&gt;
<span class="pl-c1">{{/each}}</span></pre></div>

<p>Save the file, the application will reload, and the two artists should appear. Well done, we have established communication between Ember and Mojolicious!</p>

<h2>
<a id="dbixclass" class="anchor" href="#dbixclass" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>DBIx::Class</h2>

<p>A few steps ago, we hard-coded the artist data, but next we will replace it with a live database connection. <a href="https://metacpan.org/pod/DBIx::Class">DBIx::Class</a> is object-relational mapper (ORM) for Perl, and it is this that we will use to allow our application to communicate with a database.</p>

<p>We're going to write some SQL scripts that will create our database. Let's create a new directory <code>mojo/db</code> and under that, we'll create the following files:</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-c"># mojo/db/01-create-database.sql</span>
<span class="pl-k">CREATE</span> <span class="pl-k">DATABASE</span> <span class="pl-en">music_app</span>;</pre></div>

<div class="highlight highlight-source-sql"><pre><span class="pl-c"># mojo/db/02-create-artist-table.sql</span>
USE music_app;

<span class="pl-k">CREATE</span> <span class="pl-k">TABLE</span> <span class="pl-en">artist</span> (
  id <span class="pl-k">INTEGER</span> AUTO_INCREMENT <span class="pl-k">PRIMARY KEY</span>,
  name <span class="pl-k">TEXT</span> <span class="pl-k">NOT NULL</span>,
  created_at <span class="pl-k">TIMESTAMP</span> DEFAULT <span class="pl-c1">CURRENT_TIMESTAMP</span>,
  updated_at <span class="pl-k">TIMESTAMP</span> DEFAULT <span class="pl-c1">CURRENT_TIMESTAMP</span> <span class="pl-k">ON</span> <span class="pl-k">UPDATE</span> <span class="pl-c1">CURRENT_TIMESTAMP</span>
);</pre></div>

<div class="highlight highlight-source-sql"><pre><span class="pl-c"># mojo/db/03-create-album-table.sql</span>
USE music_app;

<span class="pl-k">CREATE</span> <span class="pl-k">TABLE</span> <span class="pl-en">album</span> (
  id <span class="pl-k">INTEGER</span> AUTO_INCREMENT <span class="pl-k">PRIMARY KEY</span>,
  artist_id <span class="pl-k">INTEGER</span> <span class="pl-k">NOT NULL</span> <span class="pl-k">REFERENCES</span> artist(id),
  title <span class="pl-k">TEXT</span> <span class="pl-k">NOT NULL</span>,
  created_at <span class="pl-k">TIMESTAMP</span> DEFAULT <span class="pl-c1">CURRENT_TIMESTAMP</span>,
  updated_at <span class="pl-k">TIMESTAMP</span> DEFAULT <span class="pl-c1">CURRENT_TIMESTAMP</span> <span class="pl-k">ON</span> <span class="pl-k">UPDATE</span> <span class="pl-c1">CURRENT_TIMESTAMP</span>
);</pre></div>

<div class="highlight highlight-source-sql"><pre><span class="pl-c"># mojo/db/xx-seed.sql</span>
USE music_app;

<span class="pl-k">INSERT INTO</span> artist
  (name)
<span class="pl-k">VALUES</span>
  (<span class="pl-s"><span class="pl-pds">"</span>Michael Jackson<span class="pl-pds">"</span></span>),
  (<span class="pl-s"><span class="pl-pds">"</span>Eminem<span class="pl-pds">"</span></span>);

<span class="pl-k">INSERT INTO</span> album
  (title, artist_id)
<span class="pl-k">VALUES</span>
  (<span class="pl-s"><span class="pl-pds">"</span>Thriller<span class="pl-pds">"</span></span>, <span class="pl-c1">1</span>),
  (<span class="pl-s"><span class="pl-pds">"</span>Bad<span class="pl-pds">"</span></span>, <span class="pl-c1">1</span>),
  (<span class="pl-s"><span class="pl-pds">"</span>The Marshall Mathers LP<span class="pl-pds">"</span></span>, <span class="pl-c1">2</span>);</pre></div>

<p>Make sure your MySQL server is running:</p>

<pre><code>$ mysql.server start
</code></pre>

<p>And then populate the database:</p>

<pre><code>~/music_app$ mysql -u root &lt; mojo/db/*.sql
</code></pre>

<p>In order for the application to be able to communicate with the database, the application will need to understand its structure. Luckily there is a tool on the CPAN which can generate the required code. Open up <code>mojo/cpanfile</code> and add three new modules:</p>

<div class="highlight highlight-source-perl"><pre>requires <span class="pl-s"><span class="pl-pds">"</span>DBD::mysql<span class="pl-pds">"</span></span>; <span class="pl-c"># allows communication with a MySQL server</span>
requires <span class="pl-s"><span class="pl-pds">"</span>DBIx::Class<span class="pl-pds">"</span></span>; <span class="pl-c"># object-relational mapper</span>
requires <span class="pl-s"><span class="pl-pds">"</span>DBIx::Class::Schema::Loader<span class="pl-pds">"</span></span>; <span class="pl-c"># code generator</span>
requires <span class="pl-s"><span class="pl-pds">"</span>Mojolicious<span class="pl-pds">"</span></span>;</pre></div>

<p>And install them (it will take a few minutes):</p>

<pre><code>~/music_app/mojo$ cpanm --installdeps .
</code></pre>

<p>DBIx::Class::Schema::Loader ships with a command line tool <code>dbicdump</code>. To generate the code, run the following:</p>

<pre><code>~/music_app/mojo$ dbicdump -o dump_directory=./lib MusicApp::Schema dbi:mysql:database=music_app root
</code></pre>

<p>This will create three new files:</p>

<pre><code>mojo/lib/MusicApp/Schema.pm # main module representing the database, allows connections to be made
mojo/lib/MusicApp/Schema/Result/Artist.pm # module representing a single artist
mojo/lib/MusicApp/Schema/Result/Album.pm # module representing a single album
</code></pre>

<p>We should now be able to replace the hard-coded artist data with calls to the database. First, we will add an attribute to our application to hold the database connection. Open <code>mojo/lib/MusicApp.pm</code>, add the following just above the <code>startup</code> subroutine.</p>

<div class="highlight highlight-source-perl"><pre>has <span class="pl-c1">schema</span> <span class="pl-k">=&gt;</span> <span class="pl-k">sub</span> {
    MusicApp::Schema<span class="pl-k">-&gt;</span><span class="pl-c1">connect</span>(<span class="pl-s"><span class="pl-pds">'</span>dbi:mysql:database=music_app<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>root<span class="pl-pds">'</span></span>);
};</pre></div>

<p>Ideally we should not hard code the connection details here. Instead they should be read from a configuration file or from the environment. We will address this later.</p>

<p>Also, note that this is a lazily-initialised attribute, meaning the code will only run just before it is needed.</p>

<p>Next, we will use the schema attribute to fetch the artist data. Replace the hard-coded <code>$artists</code> with:</p>

<div class="highlight highlight-source-perl"><pre>
<span class="pl-k">my</span> <span class="pl-smi">$artists</span> = [
    <span class="pl-c1">map</span> {
        +{
            <span class="pl-c1">id</span>   <span class="pl-k">=&gt;</span> <span class="pl-smi">$_</span><span class="pl-k">-&gt;</span>id,
            <span class="pl-c1">name</span> <span class="pl-k">=&gt;</span> <span class="pl-smi">$_</span><span class="pl-k">-&gt;</span>name,
        }
    }
    <span class="pl-smi">$self</span><span class="pl-k">-&gt;</span>schema<span class="pl-k">-&gt;</span>resultset(<span class="pl-s"><span class="pl-pds">"</span>Artist<span class="pl-pds">"</span></span>)<span class="pl-k">-&gt;</span>all
];</pre></div>

<p>We are asking for <code>all</code> the results of type <code>Artist</code> and then we pull out the specific data that we wish to serve in the JSON payload. If you reload the front-end now, you should see the same output, but it will be reading the data from the database!</p>

<h2>
<a id="summary" class="anchor" href="#summary" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Summary</h2>

<p>The data is now flowing from the MySQL database to the back-end Mojolicious server to the front-end Ember application. In the next part of the tutorial, we will refactor some of the existing code, and expose the related albums to the front-end.</p>

<hr>

<p>Keith Broughton | Full-Stack Developer</p>

<p>Twitter: <a href="https://twitter.com/keithbro">@keithbro</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/keithbro/build-an-app-with-mojolicious-and-ember-part-2">Building a web application with Mojolicious and Ember - Part Two</a> is maintained by <a href="https://github.com/keithbro">keithbro</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
